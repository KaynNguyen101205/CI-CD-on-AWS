---
- name: Harden Jenkins host security group and system services
  hosts: localhost
  gather_facts: false
  vars:
    aws_region: "{{ lookup('env', 'AWS_REGION') | default('us-east-1', true) }}"
    sg_id: "{{ lookup('env', 'JENKINS_SG_ID') }}"
    my_ip: "{{ lookup('env', 'MY_PUBLIC_IP') }}"
    jenkins_port: "{{ lookup('env', 'JENKINS_PORT') | default(8080, true) }}"
    ssh_port: 22

  pre_tasks:
    - name: Check required variables
      ansible.builtin.assert:
        that:
          - sg_id is defined and sg_id | length > 0
          - my_ip is defined and my_ip | length > 0
        fail_msg: "Set env vars JENKINS_SG_ID and MY_PUBLIC_IP before running."
        success_msg: "Security group ID and caller IP provided."

  tasks:
    - name: Allow SSH from my IP only
      amazon.aws.ec2_security_group:
        region: "{{ aws_region }}"
        group_id: "{{ sg_id }}"
        purge_rules: no
        rules:
          - proto: tcp
            from_port: "{{ ssh_port }}"
            to_port: "{{ ssh_port }}"
            cidr_ip: "{{ my_ip }}/32"
      register: ssh_rule

    - name: Allow Jenkins HTTP from my IP only
      amazon.aws.ec2_security_group:
        region: "{{ aws_region }}"
        group_id: "{{ sg_id }}"
        purge_rules: no
        rules:
          - proto: tcp
            from_port: "{{ jenkins_port }}"
            to_port: "{{ jenkins_port }}"
            cidr_ip: "{{ my_ip }}/32"
      register: http_rule

    - name: Remove broad SSH/HTTP ingress
      amazon.aws.ec2_security_group:
        region: "{{ aws_region }}"
        group_id: "{{ sg_id }}"
        purge_rules: no
        rules_egress: []
        rules:
          - proto: tcp
            from_port: "{{ ssh_port }}"
            to_port: "{{ ssh_port }}"
            cidr_ip: 0.0.0.0/0
            rule_desc: "cleanup-ssh-anywhere"
          - proto: tcp
            from_port: "{{ jenkins_port }}"
            to_port: "{{ jenkins_port }}"
            cidr_ip: 0.0.0.0/0
            rule_desc: "cleanup-jenkins-anywhere"
        state: absent

    - name: Show applied security group changes
      ansible.builtin.debug:
        msg:
          - "SSH ingress restricted to {{ my_ip }}/32"
          - "Jenkins ingress restricted to {{ my_ip }}/32"

- name: Harden Jenkins host services and logging
  hosts: jenkins
  become: true
  gather_facts: true

  vars:
    auditd_package: auditd
    fail2ban_package: fail2ban

  tasks:
    - name: Ensure unattended upgrades installed
      ansible.builtin.apt:
        name: unattended-upgrades
        state: present
        update_cache: true

    - name: Enable unattended upgrades
      ansible.builtin.lineinfile:
        path: /etc/apt/apt.conf.d/20auto-upgrades
        regexp: '^APT::Periodic::Unattended-Upgrade'
        line: 'APT::Periodic::Unattended-Upgrade "1";'

    - name: Install auditd
      ansible.builtin.apt:
        name: "{{ auditd_package }}"
        state: present

    - name: Ensure auditd service enabled
      ansible.builtin.service:
        name: auditd
        state: started
        enabled: true

    - name: Install fail2ban
      ansible.builtin.apt:
        name: "{{ fail2ban_package }}"
        state: present

    - name: Deploy fail2ban jail for sshd
      ansible.builtin.copy:
        dest: /etc/fail2ban/jail.d/ssh.local
        content: |
          [sshd]
          enabled = true
          port    = ssh
          filter  = sshd
          logpath = /var/log/auth.log
          maxretry = 5
          bantime = 3600
        mode: "0644"
      notify: Restart fail2ban

    - name: Deploy fail2ban jail for jenkins port
      ansible.builtin.copy:
        dest: /etc/fail2ban/jail.d/jenkins.local
        content: |
          [jenkins]
          enabled = true
          port    = 8080
          filter  = jenkins
          logpath = /var/log/jenkins/jenkins.log
          maxretry = 5
          bantime = 3600
        mode: "0644"
      notify: Restart fail2ban

    - name: Install fail2ban filter for Jenkins
      ansible.builtin.copy:
        dest: /etc/fail2ban/filter.d/jenkins.conf
        content: |
          [Definition]
          failregex = ^<HOST> .* Failed to authenticate
          ignoreregex =
        mode: "0644"
      notify: Restart fail2ban

    - name: Restart Jenkins to ensure new logs rotate
      ansible.builtin.service:
        name: jenkins
        state: restarted

  handlers:
    - name: Restart fail2ban
      ansible.builtin.service:
        name: fail2ban
        state: restarted

